{% extends 'base.html' %}
{% set active = "project" %}

{% block title %}
Project
{% endblock %}

{% block content %}
    <main>
        <section class="container">
            <div class="list-column">
                <div class="list">
                    <div class="list-header" style="height: 60px; align-items: center; background-color: rgb(46, 215, 216); padding-left: 15px; padding-right: 15px; border-radius: 4px ">
                        <h2 class="list-title">To Do</h2>
                        <button class="add-card">+ Add a card</button>
                        
                    </div>
                    <div class="list-body">
                            
                    </div>                
                    
                    <div class="list-footer">
                        <button class="delete-list">Delete List</button>
                    </div>
                </div>
                <div class="list">
                    <div class="list-header" style="height: 60px; align-items: center; background-color: rgb(0, 170, 255); padding-left: 15px; padding-right: 15px; border-radius: 4px">
                        <h2 class="list-title">In Progress</h2>
                        <button class="add-card">+ Add a card</button>
                    </div>
                    <div class="list-body">
                    </div>
                    <div class="list-footer">
                        <button class="delete-list">Delete List</button>
                    </div>
                </div>
                <div class="list">
                    <div class="list-header" style="height: 60px; align-items: center; background-color: rgb(161, 121, 242); padding-left: 15px; padding-right: 15px; border-radius: 4px ">
                        <h2 class="list-title">Done</h2>
                        <button class="add-card">+ Add a card</button>
                    </div>
                    <div class="list-body">
                    </div>
                    <div class="list-footer">
                        <button class="delete-list">Delete List</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
</body>

<script>

    const addCardButtons = document.querySelectorAll('.add-card');

    window.addEventListener('DOMContentLoaded', function() {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/get-tasks');
      xhr.onload = function() {
        if (this.status === 200) {
          const tasks = JSON.parse(this.responseText);
          const listBodies = document.querySelectorAll('.list-body');
          for (let i = 0; i < listBodies.length; i++) {
            const listBody = listBodies[i];
            const status = listBody.parentNode.querySelector('.list-title').textContent;
            if (status in tasks) {
              for (let j = 0; j < tasks[status].length; j++) {
                const task = tasks[status][j];
                const card = document.createElement('div');
                card.classList.add('card');
                card.setAttribute('data-id', task.id);

                const title = document.createElement('input');
                title.type = 'text';
                title.contenteditable = true;
                title.value = task.title;
                card.appendChild(title);

                const description = document.createElement('textarea');
                description.contenteditable = true;
                description.setAttribute('name', 'description');
                description.value = task.description;
                card.appendChild(description);

                listBody.appendChild(card);
              }
            }
          }
        }
      };
      xhr.send();
    });



    addCardButtons.forEach(function(addCardButton) {
        addCardButton.addEventListener('click', function() {
            const card = document.createElement('div');
            card.classList.add('card');
            card.setAttribute('data-id', Math.random().toString(36).substring(2, 15)); // generate a random id

            card.setAttribute('draggable', true);


            const title = document.createElement('input');
            title.type = 'text';
            title.contenteditable = true;
            card.appendChild(title);

            const description = document.createElement('textarea');
            description.contenteditable = true;
            description.setAttribute('name', 'description');
            card.appendChild(description);

            title.value = '';
            description.value = '';

            const listBody = addCardButton.parentNode.nextElementSibling;
            listBody.appendChild(card);


            let timeoutId; // define a variable to hold the timeout ID



            // add event listener to submit the form data to the server when the input fields are blurred
            title.addEventListener('blur', function() {
                const formData = {
                    id: card.getAttribute('data-id'), // add id to form data
                    title: title.value,
                    description: description.value,
                    status: listBody.parentNode.querySelector('.list-title').textContent
                };

                if (formData.title.trim() === '' && formData.description.trim() === '') {
                    // do nothing if the card title and description are empty
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/save-card', true);
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.onload = function() {
                    if (this.status === 200) {
                        console.log('Card saved successfully!');
                    }
                };
                    xhr.send(JSON.stringify(formData));
            });





            // debounce the description input event
            description.addEventListener('input', function() {
                clearTimeout(timeoutId); // clear the previous timeout
                timeoutId = setTimeout(function() {
                    const formData = {
                        id: card.getAttribute('data-id'), // add id to form data
                        title: title.value,
                        description: description.value,
                        status: listBody.parentNode.querySelector('.list-title').textContent
                    };

                    if (formData.title.trim() === '' && formData.description.trim() === '') {
                        // do nothing if the card title and description are empty
                        return;
                    }

                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/save-card', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.onload = function() {
                        if (this.status === 200) {
                            console.log('Card saved successfully!');
                        }
                    };
                        xhr.send(JSON.stringify(formData));
                }, 500); // wait for 500 milliseconds before sending the request
            });




            const cards = document.querySelectorAll('.card');

            cards.forEach(function(card) {
                card.addEventListener('dragstart', function(event) {
                    event.dataTransfer.setData('text/plain', card.getAttribute('data-id'));
                    event.dataTransfer.effectAllowed = 'move';
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', function(event) {
                    card.classList.remove('dragging');
                });

            });

            const lists = document.querySelectorAll('.list');

            lists.forEach(function(list) {
                list.addEventListener('dragover', function(event) {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'move';
                    list.classList.add('drag-over');
                });

                list.addEventListener('dragleave', function(event) {
                    list.classList.remove('drag-over');
                });

                list.addEventListener('drop', function(event) {
                    event.preventDefault();
                    const cardId = event.dataTransfer.getData('text/plain');
                    const card = document.querySelector(`[data-id="${cardId}"]`);
                    const oldList = card.parentNode;
                    const newList = list.querySelector('.list-body');
                    newList.appendChild(card);
                    list.classList.remove('drag-over');


                    const formData = {
                    id: card.getAttribute('data-id'), // add id to form data
                    title: title.value,
                    description: description.value,
                    status: listBody.parentNode.querySelector('.list-title').textContent
                    };

                    if (formData.title.trim() === '' && formData.description.trim() === '') {
                        // do nothing if the card title and description are empty
                        return;
                    }

                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/save-card', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.onload = function() {
                        if (this.status === 200) {
                            console.log('Card status updated successfully!');
                        }
                    };
                    xhr.send(JSON.stringify(formData));
                });
            });



        });
    });










</script>

{% endblock %}
